<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบทะเบียนบุคลากร - สถาบันบำราศนราดูร</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700;800&display=swap');
        
        body { 
            font-family: 'Sarabun', sans-serif; 
            font-size: 18px;
            line-height: 1.6;
        }
        
        .glass-effect {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        
        .form-section {
            background: rgba(255, 255, 255, 0.98);
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .form-group {
            margin-bottom: 1rem;
        }
        
        .form-label {
            display: block;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 0.75rem;
            font-size: 1rem;
        }
        
        .form-input {
            width: 100%;
            padding: 1rem;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.95);
            font-weight: 500;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #f8b4cb;
            box-shadow: 0 0 0 4px rgba(248, 180, 203, 0.25);
            background: rgba(255, 255, 255, 1);
            transform: translateY(-2px);
        }
        
        .section-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .fade-in {
            animation: fadeIn 0.6s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-12px); }
            60% { transform: translateY(-6px); }
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.15); }
            100% { transform: scale(1); }
        }
        
        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-15px); }
        }
        
        .animate-bounce { animation: bounce 2s infinite; }
        .animate-pulse { animation: pulse 2s infinite; }
        .animate-rotate { animation: rotate 3s linear infinite; }
        .animate-float { animation: float 3s ease-in-out infinite; }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(8px);
        }
        
        .modal-content {
            background: linear-gradient(135deg, #fef7ff 0%, #f3e8ff 100%);
            margin: 2% auto;
            padding: 2.5rem;
            border-radius: 20px;
            width: 90%;
            max-width: 900px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #f8b4cb 0%, #c084fc 100%);
            color: #1f2937;
            font-weight: 700;
            font-size: 1.125rem;
            padding: 1.25rem 2rem;
            border-radius: 16px;
            transition: all 0.3s ease;
            box-shadow: 0 8px 25px rgba(248, 180, 203, 0.4);
        }
        
        .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 35px rgba(248, 180, 203, 0.6);
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
            color: #1f2937;
            font-weight: 700;
            font-size: 1.125rem;
            padding: 1.25rem 2rem;
            border-radius: 16px;
            transition: all 0.3s ease;
            box-shadow: 0 8px 25px rgba(251, 191, 36, 0.4);
        }
        
        .btn-secondary:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 35px rgba(251, 191, 36, 0.6);
        }
        
        .header-title {
            font-size: 2rem;
            font-weight: 800;
            color: #1e40af;
        }
        
        .header-subtitle {
            font-size: 1.125rem;
            font-weight: 600;
            color: #1e3a8a;
        }
        
        /* Mobile Optimizations */
        @media (max-width: 768px) {
            body {
                font-size: 14px;
                line-height: 1.4;
            }
            
            .form-section {
                padding: 1rem;
                margin-bottom: 1rem;
                border-radius: 12px;
            }
            
            .modal-content {
                margin: 2% auto;
                padding: 1rem;
                width: 98%;
                max-height: 95vh;
            }
            
            .section-title {
                font-size: 1.1rem;
                margin-bottom: 1rem;
            }
            
            .header-title {
                font-size: 1.3rem;
            }
            
            .header-subtitle {
                font-size: 0.9rem;
            }
            
            .form-input {
                padding: 0.75rem;
                font-size: 0.9rem;
                border-radius: 8px;
            }
            
            .form-label {
                font-size: 0.85rem;
                margin-bottom: 0.5rem;
            }
            
            .btn-primary, .btn-secondary {
                padding: 1rem 1.5rem;
                font-size: 1rem;
                border-radius: 12px;
            }
            
            .grid {
                gap: 0.75rem;
            }
            
            .container {
                padding-left: 0.5rem;
                padding-right: 0.5rem;
            }
            
            /* Optimize image previews for mobile */
            .image-preview {
                width: 120px;
                height: 120px;
            }
            
            /* Faster animations on mobile */
            .animate-bounce, .animate-pulse, .animate-rotate, .animate-float {
                animation-duration: 1s;
            }
            
            /* Reduce backdrop blur for better performance */
            .glass-effect {
                backdrop-filter: blur(8px);
            }
            
            /* Optimize modal for mobile */
            .modal {
                backdrop-filter: blur(4px);
            }
        }
        
        /* Performance optimizations */
        * {
            -webkit-tap-highlight-color: transparent;
        }
        
        .form-input {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }
        
        /* Lazy loading for images */
        .image-preview {
            loading: lazy;
        }
        
        /* Reduce repaints */
        .form-section {
            will-change: transform;
        }
        
        .image-preview {
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }
        
        .image-preview:hover {
            transform: scale(1.05);
        }
        
        .status-indicator {
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.875rem;
        }
        
        .loading-spinner {
            border: 3px solid #f3f4f6;
            border-top: 3px solid #f8b4cb;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-emerald-50 via-teal-50 to-cyan-100">

    <!-- Header -->
    <header class="glass-effect p-6 mb-10">
        <div class="container mx-auto flex items-center justify-center">
            <div class="flex items-center space-x-6">
                <i class="fas fa-hospital text-blue-600 text-4xl animate-pulse"></i>
                <div class="text-center">
                    <h1 class="header-title">ระบบทะเบียนบุคลากร</h1>
                    <p class="header-subtitle">สถาบันบำราศนราดูร</p>
                </div>
            </div>
        </div>
    </header>

    <div class="container mx-auto px-4">
        <!-- Registration Form -->
        <div id="registrationForm" class="fade-in">
            <div class="max-w-7xl mx-auto px-4">
                <form id="staffForm">
                    <!-- ข้อมูลส่วนตัว -->
                    <div class="form-section">
                        <h3 class="section-title">
                            <i class="fas fa-user text-pink-500 animate-bounce"></i>ข้อมูลส่วนตัว
                        </h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            <div class="form-group">
                                <label class="form-label"><i class="fas fa-id-card text-blue-500 mr-3"></i>เลขที่บัตรประจำตัวประชาชน *</label>
                                <input type="text" name="idCard" required class="form-input" maxlength="13" placeholder="1234567890123">
                            </div>
                            <div class="form-group">
                                <label class="form-label"><i class="fas fa-user-tag text-purple-500 mr-3"></i>คำนำหน้า *</label>
                                <select name="prefix" required class="form-input">
                                    <option value="">เลือกคำนำหน้า</option>
                                    <option value="นาย">นาย</option>
                                    <option value="นาง">นาง</option>
                                    <option value="นางสาว">นางสาว</option>
                                    <option value="อื่นๆ">อื่นๆ</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label"><i class="fas fa-signature text-pink-500 mr-3"></i>ชื่อ - นามสกุล *</label>
                                <input type="text" name="fullName" required class="form-input" placeholder="ชื่อ นามสกุล">
                            </div>
                            <div class="form-group">
                                <label class="form-label"><i class="fas fa-birthday-cake text-orange-500 mr-3"></i>วันเดือนปีเกิด *</label>
                                <input type="date" name="birthDate" required class="form-input" onchange="calculateAge()">
                            </div>
                            <div class="form-group">
                                <label class="form-label"><i class="fas fa-phone text-green-500 mr-3"></i>หมายเลขโทรศัพท์</label>
                                <input type="tel" name="phone" class="form-input" placeholder="08xxxxxxxx" maxlength="10">
                            </div>
                            <div class="form-group">
                                <label class="form-label"><i class="fas fa-envelope text-red-500 mr-3"></i>อีเมลล์</label>
                                <input type="email" name="email" class="form-input" placeholder="example@email.com">
                            </div>
                            <div class="form-group">
                                <label class="form-label"><i class="fas fa-calendar-alt text-indigo-500 mr-3"></i>อายุ</label>
                                <input type="number" name="age" class="form-input bg-gray-100" readonly placeholder="คำนวณอัตโนมัติ">
                            </div>
                            <div class="form-group">
                                <label class="form-label"><i class="fas fa-hourglass-end text-amber-500 mr-3"></i>ปีที่เกษียณอายุราชการ</label>
                                <input type="number" name="retirementYear" class="form-input bg-gray-100" readonly placeholder="คำนวณอัตโนมัติ">
                            </div>
                        </div>
                        <div class="form-group mt-6">
                            <label class="form-label"><i class="fas fa-camera text-cyan-500 mr-3"></i>รูปภาพประจำตัว</label>
                            <input type="file" name="personalImage" accept="image/*" class="form-input" onchange="previewImage(this, 'personalImagePreview', 'personalImageStatus')">
                            <div id="personalImagePreview" class="mt-4"></div>
                            <div id="personalImageStatus" class="mt-2"></div>
                        </div>
                    </div>

                    <!-- ข้อมูลตำแหน่งงาน -->
                    <div class="form-section">
                        <h3 class="section-title">
                            <i class="fas fa-briefcase text-purple-600 animate-pulse"></i>ข้อมูลตำแหน่งงาน
                        </h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            <div class="form-group">
                                <label class="form-label"><i class="fas fa-building text-blue-600 mr-3"></i>หน่วยงานที่ปฏิบัติงานปัจจุบัน</label>
                                <select name="department" class="form-input">
                                    <option value="">เลือกหน่วยงาน</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label"><i class="fas fa-user-tie text-indigo-600 mr-3"></i>ตำแหน่ง</label>
                                <select name="position" class="form-input">
                                    <option value="">เลือกตำแหน่ง</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label"><i class="fas fa-hashtag text-purple-600 mr-3"></i>เลขที่ประจำตำแหน่ง</label>
                                <input type="text" name="positionNumber" class="form-input" placeholder="เลขที่ตำแหน่ง">
                            </div>
                            <div class="form-group">
                                <label class="form-label"><i class="fas fa-layer-group text-teal-600 mr-3"></i>ระดับของตำแหน่ง</label>
                                <select name="positionLevel" class="form-input">
                                    <option value="">เลือกระดับตำแหน่ง</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label"><i class="fas fa-tags text-emerald-600 mr-3"></i>ประเภทของตำแหน่ง</label>
                                <select name="positionType" class="form-input">
                                    <option value="">เลือกประเภทตำแหน่ง</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label"><i class="fas fa-star text-yellow-600 mr-3"></i>ด้านความชำนาญของตำแหน่ง</label>
                                <select name="expertise" class="form-input">
                                    <option value="">เลือกด้านความชำนาญ</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- ข้อมูลวิชาชีพ -->
                    <div class="form-section">
                        <h3 class="section-title">
                            <i class="fas fa-certificate text-emerald-500 animate-rotate"></i>ข้อมูลวิชาชีพ
                        </h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            <div class="form-group">
                                <label class="form-label"><i class="fas fa-id-badge text-blue-500 mr-3"></i>เลขที่ใบประกอบวิชาชีพ</label>
                                <input type="text" name="licenseNumber" class="form-input" placeholder="เลขที่ใบประกอบวิชาชีพ">
                            </div>
                            <div class="form-group">
                                <label class="form-label"><i class="fas fa-user-nurse text-pink-500 mr-3"></i>เลขที่สมาชิกสภาการพยาบาล</label>
                                <input type="text" name="nursingCouncilNumber" class="form-input" placeholder="เลขที่สมาชิก">
                            </div>
                            <div class="form-group">
                                <label class="form-label"><i class="fas fa-calendar-times text-red-500 mr-3"></i>วันหมดอายุใบประกอบวิชาชีพ</label>
                                <input type="date" name="licenseExpiry" class="form-input">
                            </div>
                            <div class="form-group">
                                <label class="form-label"><i class="fas fa-play-circle text-green-500 mr-3"></i>วันที่เริ่มปฏิบัติงาน</label>
                                <input type="date" name="startDate" class="form-input" onchange="calculateWorkExperience()">
                            </div>
                            <div class="form-group">
                                <label class="form-label"><i class="fas fa-clock text-orange-500 mr-3"></i>อายุงาน</label>
                                <input type="text" name="workExperience" class="form-input bg-gray-100" readonly placeholder="คำนวณอัตโนมัติ">
                            </div>
                            <div class="form-group">
                                <label class="form-label"><i class="fas fa-calendar-check text-purple-500 mr-3"></i>วันที่บรรจุราชการ</label>
                                <input type="date" name="appointmentDate" class="form-input">
                            </div>
                            <div class="form-group">
                                <label class="form-label"><i class="fas fa-medal text-yellow-500 mr-3"></i>วันที่ดำรงตำแหน่ง พยาบาลวิชาชีพชำนาญการ</label>
                                <input type="date" name="specialistDate" class="form-input">
                            </div>
                        </div>
                        <div class="form-group mt-6">
                            <label class="form-label"><i class="fas fa-file-medical text-teal-500 mr-3"></i>แนบเอกสารใบประกอบวิชาชีพ</label>
                            <input type="file" name="licenseDocument" accept="image/*,.pdf" class="form-input" onchange="previewImage(this, 'licenseDocumentPreview', 'licenseDocumentStatus')">
                            <div id="licenseDocumentPreview" class="mt-4"></div>
                            <div id="licenseDocumentStatus" class="mt-2"></div>
                        </div>
                    </div>

                    <!-- ข้อมูลการศึกษา -->
                    <div class="form-section">
                        <h3 class="section-title">
                            <i class="fas fa-graduation-cap text-indigo-600 animate-float"></i>ข้อมูลการศึกษา
                        </h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="form-group">
                                <label class="form-label"><i class="fas fa-university text-blue-600 mr-3"></i>ระดับการศึกษาสูงสุด</label>
                                <select name="educationLevel" class="form-input">
                                    <option value="">เลือกระดับการศึกษา</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label"><i class="fas fa-graduation-cap text-green-600 mr-3"></i>วุฒิปริญญาตรี สาขา</label>
                                <input type="text" name="bachelorField" class="form-input" placeholder="สาขาวิชา">
                            </div>
                            <div class="form-group">
                                <label class="form-label"><i class="fas fa-user-graduate text-purple-600 mr-3"></i>วุฒิปริญญาโท สาขา</label>
                                <input type="text" name="masterField" class="form-input" placeholder="สาขาวิชา">
                            </div>
                            <div class="form-group">
                                <label class="form-label"><i class="fas fa-crown text-yellow-600 mr-3"></i>วุฒิปริญญาเอก สาขา</label>
                                <input type="text" name="doctoralField" class="form-input" placeholder="สาขาวิชา">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label"><i class="fas fa-stethoscope text-pink-600 mr-3"></i>หลักสูตรการพยาบาลเฉพาะทางสาขา</label>
                            <input type="text" name="specializedNursing" class="form-input" placeholder="สาขาการพยาบาลเฉพาะทาง">
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6">
                            <div class="form-group">
                                <label class="form-label"><i class="fas fa-scroll text-indigo-500 mr-3"></i>แนบเอกสารใบสำเร็จการศึกษา</label>
                                <input type="file" name="educationDocument" accept="image/*,.pdf" class="form-input" onchange="previewImage(this, 'educationDocumentPreview', 'educationDocumentStatus')">
                                <div id="educationDocumentPreview" class="mt-4"></div>
                                <div id="educationDocumentStatus" class="mt-2"></div>
                            </div>
                            <div class="form-group">
                                <label class="form-label"><i class="fas fa-certificate text-amber-500 mr-3"></i>แนบเอกสารวุฒิบัตร</label>
                                <input type="file" name="specializedDocument" accept="image/*,.pdf" class="form-input" onchange="previewImage(this, 'specializedDocumentPreview', 'specializedDocumentStatus')">
                                <div id="specializedDocumentPreview" class="mt-4"></div>
                                <div id="specializedDocumentStatus" class="mt-2"></div>
                            </div>
                        </div>
                    </div>

                    <!-- ข้อมูลเพิ่มเติม -->
                    <div class="form-section">
                        <h3 class="section-title">
                            <i class="fas fa-info-circle text-orange-500 animate-pulse"></i>ข้อมูลเพิ่มเติม
                        </h3>
                        <div class="form-group">
                            <label class="form-label"><i class="fas fa-clipboard-list text-teal-600 mr-3"></i>ประเภทการเข้า/ออกปฏิบัติการในสถาบันบำราศนราดูร</label>
                            <input type="text" name="workType" class="form-input" placeholder="กรอกประเภทการปฏิบัติงาน">
                        </div>
                    </div>

                    <!-- ปุ่มบันทึก -->
                    <div class="form-section">
                        <div class="flex gap-6">
                            <button type="submit" class="flex-1 btn-primary flex items-center justify-center">
                                <i class="fas fa-save mr-4 animate-bounce text-yellow-600 text-xl"></i>บันทึกข้อมูล
                            </button>
                            <button type="button" id="clearFormBtn" onclick="clearForm()" class="flex-1 btn-secondary flex items-center justify-center" style="display: none;">
                                <i class="fas fa-broom mr-4 text-blue-600 text-xl"></i>ล้างข้อมูล
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- Data Details Modal -->
        <div id="dataModal" class="modal">
            <div class="modal-content">
                <div class="flex justify-between items-center mb-8">
                    <h2 class="text-3xl font-bold text-gray-800 flex items-center">
                        <i class="fas fa-user-check text-emerald-500 mr-4 animate-bounce"></i>
                        ข้อมูลที่บันทึกเรียบร้อยแล้ว
                    </h2>
                    <button onclick="closeModal()" class="text-gray-500 hover:text-gray-700 text-3xl">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div id="modalContent" class="space-y-6">
                    <!-- Content will be populated by JavaScript -->
                </div>
                <div class="flex gap-6 mt-8">
                    <button onclick="editData()" class="flex-1 btn-primary flex items-center justify-center">
                        <i class="fas fa-edit mr-3 animate-pulse text-yellow-300 text-lg"></i>แก้ไขข้อมูล
                    </button>
                    <button onclick="closeModal()" class="flex-1 btn-secondary flex items-center justify-center">
                        <i class="fas fa-check mr-3 text-green-400 text-lg"></i>ปิด
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuration - ตรงกับโค้ด GS ของคุณ
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwettDCjvdFPKV4dk_Kl0zwzN7kIVfchsmKgIEAwcQNgWIZyrU6Ecb8RQrjyBx3IAg57A/exec';
        const SHEET_ID = '1COt-ehxsy2b8B7zomUozR9Qpuo6j09rsGKSlaGABQro';
        const SHEET_NAME = 'ชีต1';
        const FOLDER_ID = '1TUm9g7DgHvy9sRsjuya-gK3D1TjqPgm_';
        
        let dropdownData = {
            departments: [],
            positions: [],
            positionLevels: [],
            positionTypes: [],
            positionExpertise: [],
            education: [],
            workTypes: []
        };

        // Auto-calculation functions
        function calculateAge() {
            const birthDateInput = document.querySelector('input[name="birthDate"]');
            const ageInput = document.querySelector('input[name="age"]');
            const retirementYearInput = document.querySelector('input[name="retirementYear"]');
            
            if (birthDateInput.value) {
                const birthDate = new Date(birthDateInput.value);
                const today = new Date();
                let age = today.getFullYear() - birthDate.getFullYear();
                const monthDiff = today.getMonth() - birthDate.getMonth();
                
                if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
                    age--;
                }
                
                ageInput.value = age;
                
                // Calculate retirement year (birth year + 60)
                const retirementYear = birthDate.getFullYear() + 60;
                retirementYearInput.value = retirementYear;
            }
        }

        function calculateWorkExperience() {
            const startDateInput = document.querySelector('input[name="startDate"]');
            const workExperienceInput = document.querySelector('input[name="workExperience"]');
            
            if (startDateInput.value) {
                const startDate = new Date(startDateInput.value);
                const today = new Date();
                
                let years = today.getFullYear() - startDate.getFullYear();
                let months = today.getMonth() - startDate.getMonth();
                
                if (months < 0) {
                    years--;
                    months += 12;
                }
                
                if (today.getDate() < startDate.getDate()) {
                    months--;
                    if (months < 0) {
                        years--;
                        months += 12;
                    }
                }
                
                let experienceText = '';
                if (years > 0) {
                    experienceText += years + ' ปี';
                }
                if (months > 0) {
                    if (experienceText) experienceText += ' ';
                    experienceText += months + ' เดือน';
                }
                if (!experienceText) {
                    experienceText = 'น้อยกว่า 1 เดือน';
                }
                
                workExperienceInput.value = experienceText;
            }
        }

        // Enhanced image compression for mobile performance
        function compressImage(file, maxWidth = 600, maxHeight = 450, quality = 0.7) {
            return new Promise((resolve) => {
                // Mobile-optimized compression settings
                const isMobile = window.innerWidth <= 768;
                const finalMaxWidth = isMobile ? Math.min(maxWidth, 400) : maxWidth;
                const finalMaxHeight = isMobile ? Math.min(maxHeight, 300) : maxHeight;
                const finalQuality = isMobile ? Math.min(quality, 0.6) : quality;
                
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const img = new Image();
                
                img.onload = function() {
                    let { width, height } = img;
                    
                    // Calculate new dimensions
                    const aspectRatio = width / height;
                    
                    if (width > height) {
                        if (width > finalMaxWidth) {
                            width = finalMaxWidth;
                            height = width / aspectRatio;
                        }
                    } else {
                        if (height > finalMaxHeight) {
                            height = finalMaxHeight;
                            width = height * aspectRatio;
                        }
                    }
                    
                    // Ensure dimensions don't exceed limits
                    if (width > finalMaxWidth) {
                        width = finalMaxWidth;
                        height = width / aspectRatio;
                    }
                    if (height > finalMaxHeight) {
                        height = finalMaxHeight;
                        width = height * aspectRatio;
                    }
                    
                    canvas.width = width;
                    canvas.height = height;
                    
                    // Use better image smoothing for mobile
                    ctx.imageSmoothingEnabled = true;
                    ctx.imageSmoothingQuality = isMobile ? 'medium' : 'high';
                    
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    // Use webp for better compression on supported browsers
                    const outputFormat = 'image/jpeg'; // Keep JPEG for compatibility
                    canvas.toBlob(resolve, outputFormat, finalQuality);
                };
                
                img.src = URL.createObjectURL(file);
            });
        }
        
        // Fast image validation
        function validateImageFile(file) {
            const validTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/webp'];
            const maxSize = 10 * 1024 * 1024; // 10MB
            
            if (!validTypes.includes(file.type)) {
                throw new Error('รองรับเฉพาะไฟล์ JPG, PNG, GIF, WebP เท่านั้น');
            }
            
            if (file.size > maxSize) {
                throw new Error('ขนาดไฟล์ต้องไม่เกิน 10MB');
            }
            
            return true;
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function getFileSizeStatus(size) {
            if (size < 500000) return { color: '🟢', text: 'ไฟล์ขนาดเหมาะสม', class: 'bg-green-100 text-green-800' };
            if (size < 1000000) return { color: '🟡', text: 'ไฟล์ปานกลาง - อาจบีบอัดเล็กน้อย', class: 'bg-yellow-100 text-yellow-800' };
            return { color: '🔴', text: 'ไฟล์ใหญ่ - จะบีบอัดอัตโนมัติ', class: 'bg-red-100 text-red-800' };
        }

        // Enhanced dropdown loading with caching and mobile optimization
        async function loadDropdownData() {
            try {
                // Check if data is cached
                const cachedData = localStorage.getItem('dropdownData');
                const cacheTime = localStorage.getItem('dropdownDataTime');
                const now = Date.now();
                
                // Use cached data if less than 5 minutes old
                if (cachedData && cacheTime && (now - parseInt(cacheTime)) < 300000) {
                    console.log('📱 Using cached dropdown data');
                    dropdownData = JSON.parse(cachedData);
                    populateDropdowns();
                    return;
                }
                
                console.log('📱 Loading fresh dropdown data...');
                
                // Mobile-optimized fetch with timeout
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 15000); // 15 second timeout
                
                const response = await fetch(SCRIPT_URL + '?action=getDropdownData', {
                    method: 'GET',
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        dropdownData = data.data;
                        
                        // Cache the data
                        localStorage.setItem('dropdownData', JSON.stringify(dropdownData));
                        localStorage.setItem('dropdownDataTime', now.toString());
                        
                        console.log('📱 Dropdown data loaded and cached');
                    }
                }
                
                populateDropdowns();
                
            } catch (error) {
                console.error('Error loading dropdown data:', error);
                
                // Try to use cached data even if expired
                const cachedData = localStorage.getItem('dropdownData');
                if (cachedData) {
                    console.log('📱 Using expired cached data as fallback');
                    dropdownData = JSON.parse(cachedData);
                }
                
                populateDropdowns();
            }
        }
        
        // Clear cache function
        function clearDropdownCache() {
            localStorage.removeItem('dropdownData');
            localStorage.removeItem('dropdownDataTime');
            console.log('📱 Dropdown cache cleared');
        }

        function populateDropdowns() {
            // Populate department dropdown
            const departmentSelect = document.querySelector('select[name="department"]');
            if (departmentSelect) {
                departmentSelect.innerHTML = '<option value="">เลือกหน่วยงาน</option>';
                
                // Add predefined departments with proper sorting
                const predefinedDepartments = [
                    'หอผู้ป่วยแยกโรค 7/2',
                    'หอผู้ป่วยแยกโรค 7/3',
                    'หอผู้ป่วยแยกโรค 7/4',
                    'หอผู้ป่วยแยกโรค 7/5'
                ];
                
                // Add predefined departments first
                predefinedDepartments.forEach(dept => {
                    departmentSelect.innerHTML += `<option value="${dept}">${dept}</option>`;
                });
                
                // Add departments from data if available
                if (dropdownData.departments && dropdownData.departments.length > 0) {
                    const uniqueDepartments = [...new Set(dropdownData.departments.filter(dept => 
                        dept && !predefinedDepartments.includes(dept)
                    ))];
                    
                    // Sort remaining departments
                    uniqueDepartments.sort();
                    
                    uniqueDepartments.forEach(dept => {
                        departmentSelect.innerHTML += `<option value="${dept}">${dept}</option>`;
                    });
                }
            }

            // Populate position dropdown
            const positionSelect = document.querySelector('select[name="position"]');
            if (positionSelect) {
                positionSelect.innerHTML = '<option value="">เลือกตำแหน่ง</option>';
                if (dropdownData.positions && dropdownData.positions.length > 0) {
                    const uniquePositions = [...new Set(dropdownData.positions.filter(pos => pos))];
                    uniquePositions.forEach(pos => {
                        positionSelect.innerHTML += `<option value="${pos}">${pos}</option>`;
                    });
                }
            }

            // Populate position level dropdown
            const positionLevelSelect = document.querySelector('select[name="positionLevel"]');
            if (positionLevelSelect) {
                positionLevelSelect.innerHTML = '<option value="">เลือกระดับตำแหน่ง</option>';
                if (dropdownData.positionLevels && dropdownData.positionLevels.length > 0) {
                    const filteredLevels = dropdownData.positionLevels.filter(level => 
                        level && 
                        level !== 'ชำนาญการพิเศษ' && 
                        level !== 'ผู้ช่วยพยาบาล'
                    );
                    const uniqueLevels = [...new Set(filteredLevels)];
                    uniqueLevels.forEach(level => {
                        positionLevelSelect.innerHTML += `<option value="${level}">${level}</option>`;
                    });
                }
                positionLevelSelect.innerHTML += `<option value="ระดับเชี่ยวชาญ">ระดับเชี่ยวชาญ</option>`;
            }

            // Populate position type dropdown
            const positionTypeSelect = document.querySelector('select[name="positionType"]');
            if (positionTypeSelect) {
                positionTypeSelect.innerHTML = '<option value="">เลือกประเภทตำแหน่ง</option>';
                if (dropdownData.positionTypes && dropdownData.positionTypes.length > 0) {
                    const filteredTypes = dropdownData.positionTypes.filter(type => 
                        type && type !== 'ผู้ช่วยพยาบาล'
                    );
                    const uniqueTypes = [...new Set(filteredTypes)];
                    uniqueTypes.forEach(type => {
                        positionTypeSelect.innerHTML += `<option value="${type}">${type}</option>`;
                    });
                }
            }

            // Populate expertise dropdown
            const expertiseSelect = document.querySelector('select[name="expertise"]');
            if (expertiseSelect) {
                expertiseSelect.innerHTML = '<option value="">เลือกด้านความชำนาญ</option>';
                if (dropdownData.positionExpertise && dropdownData.positionExpertise.length > 0) {
                    const filteredExpertise = dropdownData.positionExpertise.filter(exp => 
                        exp && exp !== 'อบัติเหตุและฉุกเฉิน'
                    );
                    const uniqueExpertise = [...new Set(filteredExpertise)];
                    uniqueExpertise.forEach(exp => {
                        expertiseSelect.innerHTML += `<option value="${exp}">${exp}</option>`;
                    });
                }
            }

            // Populate education level dropdown
            const educationSelect = document.querySelector('select[name="educationLevel"]');
            if (educationSelect) {
                educationSelect.innerHTML = '<option value="">เลือกระดับการศึกษา</option>';
                if (dropdownData.education && dropdownData.education.length > 0) {
                    const uniqueEducation = [...new Set(dropdownData.education.filter(edu => edu))];
                    uniqueEducation.forEach(edu => {
                        educationSelect.innerHTML += `<option value="${edu}">${edu}</option>`;
                    });
                }
            }
        }

        // Enhanced mobile-optimized image upload function
        async function handleImageUpload(file) {
            if (!file) return '';
            
            try {
                // Validate file first
                validateImageFile(file);
                
                const originalSize = file.size;
                let compressedFile = file;
                
                // Mobile-optimized compression thresholds
                const isMobile = window.innerWidth <= 768;
                const compressionThreshold = isMobile ? 300000 : 800000; // 300KB for mobile, 800KB for desktop
                const maxFinalSize = isMobile ? 500000 : 1500000; // 500KB for mobile, 1.5MB for desktop
                
                // Compress if file is too large
                if (file.size > compressionThreshold) {
                    const maxWidth = isMobile ? 400 : 800;
                    const maxHeight = isMobile ? 300 : 600;
                    const quality = isMobile ? 0.6 : 0.7;
                    
                    compressedFile = await compressImage(file, maxWidth, maxHeight, quality);
                    
                    // If still too large, compress more aggressively
                    if (compressedFile.size > maxFinalSize) {
                        const aggressiveWidth = isMobile ? 300 : 600;
                        const aggressiveHeight = isMobile ? 225 : 450;
                        const aggressiveQuality = isMobile ? 0.4 : 0.5;
                        
                        compressedFile = await compressImage(file, aggressiveWidth, aggressiveHeight, aggressiveQuality);
                    }
                }
                
                // Convert to base64 with proper MIME type matching GS format
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const result = e.target.result;
                        
                        // Validate base64 format to match GS expectations
                        if (!result || !result.includes('data:') || !result.includes(',')) {
                            reject(new Error('รูปแบบ base64 ไม่ถูกต้อง'));
                            return;
                        }
                        
                        // Use regex matching exactly like GS code
                        const matches = result.match(/^data:([^;]+);base64,(.+)$/);
                        if (!matches) {
                            reject(new Error('ไม่สามารถแยก MIME type ได้'));
                            return;
                        }
                        
                        const mimeType = matches[1];
                        const base64Content = matches[2];
                        
                        // Validate MIME type
                        const validMimeTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/webp'];
                        if (!validMimeTypes.includes(mimeType)) {
                            reject(new Error('รูปแบบไฟล์ไม่รองรับ: ' + mimeType));
                            return;
                        }
                        
                        // Validate base64 content
                        if (!base64Content || base64Content.length === 0) {
                            reject(new Error('ข้อมูลรูปภาพว่างเปล่า'));
                            return;
                        }
                        
                        // Check final size for mobile optimization
                        const finalSizeEstimate = (base64Content.length * 3) / 4; // Rough base64 to bytes conversion
                        
                        console.log(`📱 Image processed (Mobile: ${isMobile}):`, {
                            mimeType,
                            originalSize: formatFileSize(originalSize),
                            compressedSize: formatFileSize(compressedFile.size),
                            base64Length: base64Content.length,
                            estimatedFinalSize: formatFileSize(finalSizeEstimate)
                        });
                        
                        resolve(result);
                    };
                    
                    reader.onerror = () => reject(new Error('ไม่สามารถอ่านไฟล์ได้'));
                    reader.readAsDataURL(compressedFile);
                });
                
            } catch (error) {
                console.error('Image upload error:', error);
                throw error;
            }
        }

        // Helper function to generate filename for image upload
        function generateImageFilename(fieldName, originalName) {
            const timestamp = Date.now();
            const extension = originalName ? originalName.split('.').pop() : 'jpg';
            return `${fieldName}_${timestamp}.${extension}`;
        }

        // Enhanced form submission compatible with GS handleUpdatePersonnel
        document.getElementById('staffForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const isUpdate = window.isUpdateMode || false;
            
            // Show simple loading alert
            Swal.fire({
                title: isUpdate ? 'กำลังอัพเดทข้อมูล...' : 'กำลังบันทึกข้อมูล...',
                html: `
                    <div class="flex flex-col items-center space-y-4">
                        <div class="loading-spinner"></div>
                    </div>
                `,
                allowOutsideClick: false,
                showConfirmButton: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });
            
            try {
                const originalFormData = new FormData(this);
                
                // Handle image uploads with progress tracking
                const imageFields = ['personalImage', 'licenseDocument', 'educationDocument', 'specializedDocument'];
                let imageCount = 0;
                let processedImages = 0;
                
                // Count total images to process
                for (const fieldName of imageFields) {
                    const imageFile = originalFormData.get(fieldName);
                    if (imageFile && imageFile.size > 0) {
                        imageCount++;
                    }
                }
                
                // Update progress (simplified)
                const updateProgress = (message) => {
                    // Progress updates removed for cleaner UI
                };
                
                // Prepare data object for GS handleUpdatePersonnel format
                const personnelData = {
                    action: isUpdate ? 'updatePersonnel' : 'addPersonnel',
                    originalIdCard: window.currentData?.idCard || originalFormData.get('idCard'),
                    idCard: originalFormData.get('idCard') || '',
                    department: originalFormData.get('department') || '',
                    positionId: originalFormData.get('positionNumber') || '',
                    prefix: originalFormData.get('prefix') || '',
                    fullName: originalFormData.get('fullName') || '',
                    position: originalFormData.get('position') || '',
                    positionLevel: originalFormData.get('positionLevel') || '',
                    positionType: originalFormData.get('positionType') || '',
                    positionExpertise: originalFormData.get('expertise') || '',
                    birthDate: originalFormData.get('birthDate') || '',
                    licenseNumber: originalFormData.get('licenseNumber') || '',
                    nursingCouncilNumber: originalFormData.get('nursingCouncilNumber') || '',
                    licenseExpiry: originalFormData.get('licenseExpiry') || '',
                    startWorkDate: originalFormData.get('startDate') || '',
                    appointmentDate: originalFormData.get('appointmentDate') || '',
                    specialistDate: originalFormData.get('specialistDate') || '',
                    retirementYear: originalFormData.get('retirementYear') || '',
                    phone: originalFormData.get('phone') || '',
                    email: originalFormData.get('email') || '',
                    education: originalFormData.get('educationLevel') || '',
                    bachelorDegree: originalFormData.get('bachelorField') || '',
                    masterDegree: originalFormData.get('masterField') || '',
                    doctoralDegree: originalFormData.get('doctoralField') || '',
                    specializedNursing: originalFormData.get('specializedNursing') || '',
                    workType: originalFormData.get('workType') || '',
                    age: originalFormData.get('age') || '',
                    workAge: originalFormData.get('workExperience') || '',
                    licenseExpiryDate: originalFormData.get('licenseExpiry') || ''
                };
                
                // Process images
                for (const fieldName of imageFields) {
                    const imageFile = originalFormData.get(fieldName);
                    if (imageFile && imageFile.size > 0) {
                        try {
                            // Process image with proper base64 encoding for GS
                            const imageData = await handleImageUpload(imageFile);
                            
                            // Add image data to personnel data object
                            personnelData[fieldName] = imageData;
                            personnelData[fieldName + '_filename'] = generateImageFilename(fieldName, imageFile.name);
                            
                            processedImages++;
                            
                            console.log(`Image ${fieldName} prepared for GS:`, {
                                filename: personnelData[fieldName + '_filename'],
                                dataLength: imageData.length,
                                mimeType: imageData.split(',')[0]
                            });
                            
                        } catch (imageError) {
                            console.error(`Error processing ${fieldName}:`, imageError);
                            
                            // Show specific error for image processing
                            Swal.close();
                            await Swal.fire({
                                icon: 'error',
                                title: 'ข้อผิดพลาดในการประมวลผลรูปภาพ',
                                html: `
                                    <div class="text-lg">
                                        <p class="mb-2">❌ ไม่สามารถประมวลผลรูปภาพได้: <strong>${fieldName}</strong></p>
                                        <p class="text-red-600 font-semibold">กรุณาตรวจสอบไฟล์รูปภาพและลองใหม่</p>
                                        <p class="text-sm text-gray-600 mt-2">ข้อผิดพลาด: ${imageError.message}</p>
                                        <div class="mt-3 p-3 bg-blue-50 rounded-lg">
                                            <p class="text-sm text-blue-800">
                                                <strong>คำแนะนำ:</strong><br>
                                                • ใช้ไฟล์รูปภาพ JPG, PNG, GIF หรือ WebP<br>
                                                • ขนาดไฟล์ไม่เกิน 5MB<br>
                                                • ตรวจสอบว่าไฟล์ไม่เสียหาย<br>
                                                • รูปภาพต้องเป็นรูปแบบที่ถูกต้อง
                                            </p>
                                        </div>
                                    </div>
                                `,
                                confirmButtonText: 'ตกลง',
                                confirmButtonColor: '#ef4444'
                            });
                            return; // Stop processing
                        }
                    }
                }

                // Send data to Google Sheets
                console.log('=== Sending Personnel Data to Google Apps Script ===');
                console.log('Action:', personnelData.action);
                console.log('ID Card:', personnelData.idCard);
                console.log('Full Name:', personnelData.fullName);
                console.log('Images:', imageFields.filter(field => personnelData[field]).length);
                console.log('=== End Data Debug ===');
                
                // Convert data to FormData for POST
                const formData = new FormData();
                Object.keys(personnelData).forEach(key => {
                    if (personnelData[key] !== null && personnelData[key] !== undefined) {
                        formData.append(key, personnelData[key]);
                    }
                });
                
                // Send data to Google Apps Script
                let responseData = null;
                let success = false;
                
                try {
                    const response = await fetch(SCRIPT_URL, {
                        method: 'POST',
                        body: formData
                    });
                    
                    const responseText = await response.text();
                    console.log('POST Response:', responseText);
                    
                    if (responseText.trim()) {
                        try {
                            responseData = JSON.parse(responseText);
                            success = responseData.success === true;
                        } catch (parseError) {
                            console.log('Could not parse POST response as JSON:', parseError);
                            // If response is OK but not JSON, consider it success for simple responses
                            if (response.ok && (responseText.includes('success') || responseText.includes('สำเร็จ'))) {
                                success = true;
                                responseData = { success: true, message: 'บันทึกข้อมูลสำเร็จ' };
                            }
                        }
                    }
                } catch (postError) {
                    console.error('POST failed:', postError);
                    throw new Error(`การส่งข้อมูลล้มเหลว: ${postError.message}`);
                }
                
                Swal.close();
                
                if (success && responseData && responseData.success) {
                    // Store data for editing
                    window.currentData = personnelData;
                    
                    // Count successful image uploads
                    const uploadedImages = imageFields.filter(field => personnelData[field]).length;
                    
                    // Show simple success message
                    await Swal.fire({
                        icon: 'success',
                        title: isUpdate ? 'อัพเดทข้อมูลสำเร็จ!' : 'บันทึกข้อมูลสำเร็จ!',
                        text: 'ข้อมูลได้ถูกบันทึกเรียบร้อยแล้ว',
                        confirmButtonText: 'ตกลง',
                        confirmButtonColor: '#10b981',
                        timer: 3000,
                        timerProgressBar: true
                    });
                    
                    if (!isUpdate) {
                        // Mark that we have submitted before
                        window.hasSubmittedBefore = true;
                        
                        // Change button to update mode
                        const submitButton = document.querySelector('button[type="submit"]');
                        submitButton.innerHTML = '<i class="fas fa-sync-alt mr-3 animate-spin text-yellow-600"></i>อัพเดทข้อมูล';
                        submitButton.className = 'flex-1 bg-gradient-to-r from-orange-300 to-red-300 hover:from-orange-400 hover:to-red-400 text-black font-semibold py-4 px-6 rounded-lg transition-all duration-300 flex items-center justify-center text-lg shadow-lg';
                        
                        // Show clear form button
                        const clearButton = document.getElementById('clearFormBtn');
                        clearButton.style.display = 'flex';
                        
                        // Set to update mode
                        window.isUpdateMode = true;
                    }
                } else {
                    // Show error message
                    await Swal.fire({
                        icon: 'error',
                        title: 'ส่งข้อมูลไม่สำเร็จ',
                        html: `
                            <div class="text-lg">
                                <p class="mb-2">❌ ไม่สามารถบันทึกข้อมูลได้</p>
                                <p class="text-red-600 font-semibold">กรุณาลองใหม่อีกครั้ง</p>
                                ${responseData && responseData.message ? `<p class="text-sm text-gray-600 mt-2">ข้อผิดพลาด: ${responseData.message}</p>` : ''}
                            </div>
                        `,
                        confirmButtonText: 'ตกลง',
                        confirmButtonColor: '#ef4444'
                    });
                }
                
            } catch (error) {
                console.error('Form submission failed:', error);
                
                Swal.close();
                
                await Swal.fire({
                    icon: 'error',
                    title: 'เกิดข้อผิดพลาด',
                    html: `
                        <div class="text-lg">
                            <p class="mb-2">❌ ไม่สามารถส่งข้อมูลได้</p>
                            <p class="text-red-600 font-semibold">กรุณาตรวจสอบการเชื่อมต่ออินเทอร์เน็ตและลองใหม่</p>
                            <p class="text-sm text-gray-600 mt-2">ข้อผิดพลาด: ${error.message}</p>
                        </div>
                    `,
                    confirmButtonText: 'ตกลง',
                    confirmButtonColor: '#ef4444'
                });
            }
        });

        // Enhanced image preview function
        function previewImage(input, previewId, statusId) {
            const preview = document.getElementById(previewId);
            const status = document.getElementById(statusId);
            
            if (input.files && input.files[0]) {
                const file = input.files[0];
                const fileSize = file.size;
                const sizeStatus = getFileSizeStatus(fileSize);
                
                // Show file info with enhanced styling
                status.innerHTML = `
                    <div class="status-indicator ${sizeStatus.class} flex items-center space-x-3">
                        <span class="text-xl">${sizeStatus.color}</span>
                        <div>
                            <div class="font-semibold">${formatFileSize(fileSize)}</div>
                            <div class="text-sm">${sizeStatus.text}</div>
                        </div>
                    </div>
                `;
                
                // Show preview for images
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        preview.innerHTML = `
                            <div class="flex justify-center">
                                <img src="${e.target.result}" alt="ตัวอย่างรูปภาพ" class="image-preview w-40 h-40 object-cover">
                            </div>
                        `;
                    };
                    reader.readAsDataURL(file);
                } else {
                    // Show file icon for non-images
                    preview.innerHTML = `
                        <div class="flex justify-center">
                            <div class="w-40 h-40 bg-gray-100 rounded-lg border-2 border-gray-300 shadow-lg flex items-center justify-center">
                                <i class="fas fa-file-pdf text-red-500 text-5xl"></i>
                            </div>
                        </div>
                    `;
                }
            } else {
                preview.innerHTML = '';
                status.innerHTML = '';
            }
        }

        // Modal functions
        function showDataModal(data) {
            const modal = document.getElementById('dataModal');
            const modalContent = document.getElementById('modalContent');
            
            const fieldLabels = {
                idCard: 'เลขบัตรประชาชน',
                prefix: 'คำนำหน้า',
                fullName: 'ชื่อ-นามสกุล',
                birthDate: 'วันเกิด',
                age: 'อายุ',
                phone: 'เบอร์โทรศัพท์',
                email: 'อีเมล',
                department: 'หน่วยงาน',
                position: 'ตำแหน่ง',
                positionNumber: 'เลขที่ประจำตำแหน่ง',
                positionLevel: 'ระดับตำแหน่ง',
                positionType: 'ประเภทตำแหน่ง',
                expertise: 'ด้านความชำนาญ',
                licenseNumber: 'เลขใบประกอบวิชาชีพ',
                nursingCouncilNumber: 'เลขที่สมาชิกสภาการพยาบาล',
                licenseExpiry: 'วันหมดอายุใบประกอบวิชาชีพ',
                startDate: 'วันที่เริ่มปฏิบัติงาน',
                appointmentDate: 'วันที่บรรจุราชการ',
                specialistDate: 'วันที่ดำรงตำแหน่งพยาบาลวิชาชีพชำนาญการ',
                retirementYear: 'ปีที่เกษียณอายุราชการ',
                education: 'ระดับการศึกษา',
                bachelorField: 'วุฒิปริญญาตรี',
                masterField: 'วุฒิปริญญาโท',
                doctoralField: 'วุฒิปริญญาเอก',
                specializedNursing: 'หลักสูตรการพยาบาลเฉพาะทาง',
                workType: 'ประเภทการปฏิบัติงาน',
                workExperience: 'อายุงาน'
            };
            
            let content = '<div class="grid grid-cols-1 md:grid-cols-2 gap-6">';
            
            Object.keys(fieldLabels).forEach(key => {
                if (data[key] && data[key] !== '') {
                    content += `
                        <div class="bg-white p-4 rounded-xl border-2 border-pink-200 shadow-sm">
                            <div class="text-sm text-gray-600 font-semibold mb-1">${fieldLabels[key]}</div>
                            <div class="text-gray-800 font-medium text-lg">${data[key]}</div>
                        </div>
                    `;
                }
            });
            
            content += '</div>';
            modalContent.innerHTML = content;
            modal.style.display = 'block';
        }
        
        function closeModal() {
            document.getElementById('dataModal').style.display = 'none';
        }
        
        function editData() {
            if (window.currentData) {
                const form = document.getElementById('staffForm');
                Object.keys(window.currentData).forEach(key => {
                    const input = form.querySelector(`[name="${key}"]`);
                    if (input && window.currentData[key]) {
                        input.value = window.currentData[key];
                    }
                });
                
                if (window.currentData.birthDate) {
                    calculateAge();
                }
                
                if (window.currentData.startWorkDate) {
                    calculateWorkExperience();
                }
                
                // Change submit button to update mode
                const submitButton = document.querySelector('button[type="submit"]');
                submitButton.innerHTML = '<i class="fas fa-sync-alt mr-3 animate-spin text-yellow-600"></i>อัพเดทข้อมูล';
                submitButton.className = 'flex-1 bg-gradient-to-r from-orange-300 to-red-300 hover:from-orange-400 hover:to-red-400 text-black font-semibold py-4 px-6 rounded-lg transition-all duration-300 flex items-center justify-center text-lg shadow-lg';
                
                // Set form to update mode
                window.isUpdateMode = true;
                
                closeModal();
                
                // Scroll to top of form
                document.getElementById('registrationForm').scrollIntoView({ 
                    behavior: 'smooth' 
                });
                
                Swal.fire({
                    icon: 'info',
                    title: 'โหมดแก้ไขข้อมูล',
                    text: 'ข้อมูลได้ถูกโหลดในฟอร์มแล้ว คุณสามารถแก้ไขและอัพเดทข้อมูลได้',
                    confirmButtonText: 'เข้าใจแล้ว',
                    confirmButtonColor: '#f8b4cb'
                });
            }
        }
        
        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('dataModal');
            if (event.target === modal) {
                closeModal();
            }
        }

        // Clear form function
        function clearForm() {
            Swal.fire({
                title: 'ต้องการล้างข้อมูลทั้งหมด?',
                text: 'ข้อมูลที่กรอกจะหายทั้งหมด',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#ef4444',
                cancelButtonColor: '#6b7280',
                confirmButtonText: 'ใช่ ล้างข้อมูล',
                cancelButtonText: 'ยกเลิก'
            }).then((result) => {
                if (result.isConfirmed) {
                    // Reset form
                    document.getElementById('staffForm').reset();
                    
                    // Clear all image previews
                    document.getElementById('personalImagePreview').innerHTML = '';
                    document.getElementById('personalImageStatus').innerHTML = '';
                    document.getElementById('licenseDocumentPreview').innerHTML = '';
                    document.getElementById('licenseDocumentStatus').innerHTML = '';
                    document.getElementById('educationDocumentPreview').innerHTML = '';
                    document.getElementById('educationDocumentStatus').innerHTML = '';
                    document.getElementById('specializedDocumentPreview').innerHTML = '';
                    document.getElementById('specializedDocumentStatus').innerHTML = '';
                    
                    // Reset to create mode
                    window.isUpdateMode = false;
                    window.hasSubmittedBefore = false;
                    window.currentData = null;
                    
                    // Reset submit button
                    const submitButton = document.querySelector('button[type="submit"]');
                    submitButton.innerHTML = '<i class="fas fa-save mr-4 animate-bounce text-yellow-600 text-xl"></i>บันทึกข้อมูล';
                    submitButton.className = 'flex-1 btn-primary flex items-center justify-center';
                    
                    // Hide clear button
                    document.getElementById('clearFormBtn').style.display = 'none';
                    
                    Swal.fire({
                        icon: 'success',
                        title: 'ล้างข้อมูลเรียบร้อย!',
                        text: 'พร้อมสำหรับการลงทะเบียนใหม่',
                        confirmButtonText: 'ตกลง',
                        confirmButtonColor: '#10b981'
                    });
                }
            });
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadDropdownData();
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'983f79bb85cb2dd4',t:'MTc1ODY4NzQ4Mi4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
